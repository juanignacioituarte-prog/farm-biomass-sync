import ee
import datetime
import os
import json

# --- 1. AUTHENTICATION ---
# GitHub Actions provides the GEE_JSON secret as an environment variable
gee_json = os.getenv('GEE_JSON')

try:
    if gee_json:
        gee_key = json.loads(gee_json)
        credentials = ee.ServiceAccountCredentials(
            gee_key['client_email'], 
            key_data=gee_json
        )
        # Your specific project ID
        ee.Initialize(credentials, project='ndvi-project-484422')
        print(f"Authenticated as: {gee_key['client_email']}")
    else:
        ee.Initialize(project='ndvi-project-484422')
except Exception as e:
    print(f"Authentication Failed: {e}")
    exit(1)

# --- 2. ASSETS ---
paddocks = ee.FeatureCollection('projects/ndvi-project-484422/assets/myfarm_paddocks')

# Filter for your specific paddocks
target_names = [
    'Back TP1', 'BP1', 'BP1 Dry', 'BP3', 'BP4', 'BP7', 'BP8', 'C1', 'C2', 'C3', 'C4', 'C5', 
    'Centre Left', 'Centre Right', 'Cottage', 'MP 15', 'MP 16', 'MP11', 'MP12', 'MP13', 
    'MP14', 'TP1', 'TP10', 'TP11', 'TP13', 'TP14', 'TP15', 'TP16', 'TP17', 'TP18', 
    'TP19', 'TP20', 'TP5', 'TP6', 'TP7','MP 17','TP3','12', 'TP8', 'TP9'
]
filtered_paddocks = paddocks.filter(ee.Filter.inList('name', target_names))

# --- 3. SATELLITE DATA ---
now = ee.Date(datetime.datetime.now())
s2 = (ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
      .filterBounds(filtered_paddocks.geometry())
      .filterDate(now.advance(-45, 'day'), now)
      .filter(ee.Filter.lte('CLOUDY_PIXEL_PERCENTAGE', 50))
      .sort('system:time_start', False)
      .first())

# --- 4. PROCESSING ---
if s2:
    ndvi = s2.normalizedDifference(['B8', 'B4']).rename('ndvi')
    
    def process_analysis(feature):
        geom = feature.geometry()
        # Find the "grazing strip" median
        median_val = ee.Number(ndvi.reduceRegion(ee.Reducer.median(), geom, 10).get('ndvi'))
        
        # Split grazed vs ungrazed
        ungrazed_mask = ndvi.gt(median_val)
        grazed_mask = ndvi.lte(median_val)
        
        # Area calc
        total_area = geom.area()
        grazed_area = ee.Image.pixelArea().updateMask(grazed_mask).reduceRegion(ee.Reducer.sum(), geom, 10).get('area')
        pct_grazed = ee.Number(grazed_area).divide(total_area).multiply(100)
        
        # NZ Effective NDVI Logic
        final_ndvi = ee.Algorithms.If(
            pct_grazed.gte(15),
            ndvi.updateMask(ungrazed_mask).reduceRegion(ee.Reducer.mean(), geom, 10).get('ndvi'),
            ndvi.reduceRegion(ee.Reducer.mean(), geom, 10).get('ndvi')
        )
        
        return feature.set({
            'paddock_name': feature.get('name'),
            'date': s2.date().format('YYYY-MM-dd'),
            'ndvi_effective': final_ndvi,
            'percent_grazed': pct_grazed,
            'cloud_pc': s2.get('CLOUDY_PIXEL_PERCENTAGE')
        })

    analyzed = filtered_paddocks.map(process_analysis)

    # --- 5. EXPORT ---
    task = ee.batch.Export.table.toDrive(
        collection=analyzed,
        description='Farm_Biomass_Update',
        folder='FarmData',
        fileNamePrefix='latest_biomass',
        fileFormat='CSV',
        selectors=['paddock_name', 'date', 'ndvi_effective', 'percent_grazed', 'cloud_pc']
    )
    
    task.start()
    print("Export task started successfully.")
else:
    print("No suitable images found within 45 days.")
